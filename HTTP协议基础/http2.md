## HTTP/2

- HTTP/2 修改了数据格式化（分帧）以及在客户端与服务器间传输的方式
- 由于 HTTP/2 引入了一个二进制分帧层，该层无法与之前的 HTTP/1.x 服务器和客户端向后兼容，所以协议的主版本提升到 HTTP/2
- HTTP 的特点
  - 使用二进制格式传输，更高效更紧凑
    - HTTP/2.x 使用二进制来标识，在底层使用`int`类型来标识，int 类型的数据占了 4 个字节。当数据变大的时候，用 int 类型存放的优势就变大了，为什么呢？如果用 ACSII 来存放`112`的话，这里是占了 3 个字节，但是如果是`11222`的话，`ASCII`就是 5 个字节，但是用 int 类型存储仍然是 4 个字节
  - 对报头压缩，降低开销
  - 多路复用，一个网络连接实现并行请求
  - 服务器主动推送，减少请求的延迟
  - 默认使用加密

HTTP/1.x 之前都是使用了`ASCII`文本进行传输，而且仅对请求数据进行了压缩

### 二进制分帧层

在 HTTP/1.1 中，请求头和请求体为了区分是请求头还是请求体，中间只隔了一对回车换行符，这样的话，容易被黑客攻击，在请求头内增加了一个畸形的请求头
HTTP/1.x 中由于是文本的原因，需要逐行去扫描来获取每个请求头的内容，然后遇到回车换行符，就知道将请求头都扫描完了，然后去扫描请求体，获取到请求体的内容
但是 HTTP/2.x 就不一样了，因为 HTTP/2.x 使用的是二进制文件进行传输。

1. 首先 HTTP/2.x 底层会计算这个请求的请求头大小，然后确定偏移量，将偏移量放到数据的最前面
2. 请求头的处理也类似这样

当服务器或者客户端要获取这些数据时，拿到偏移量，然后去数据的二进制数据中，找到匹配的数据，同样的去找到请求体的二进制数据

### 多路复用

在 HTTP/1.x 中，如果只靠一个 TCP 连接想要传输多个文件，只能一个一个进行传输
如果要进行并行传输多个文件，只能开启多个 TCP 连接才能做到。但是这有个问题，由于服务器压力的原因，一般来说每个用户也不敢给开太多个 TCP 连接给他们用。

在 HTTP/2.x 中实现的多路复用：由于 HTTP/2.x 使用的是二进制进行传输，容易切割成一块一块的来进行传输，HTTP/2 就使用并行传输多个请求的数据，如：传输 html,js,css.可以将 html，js，css 分割成一小块。交替进行发送。

总结：

- 在 HTTP/1.x 中，如果客户端要向发送多个并行请求以提升性能，则必须使用多个 TCP 连接。这样的模型也会导致队首阻塞，从而造成 TCP 连接的效率地下

- 将 HTTP 消息分解成独立的帧，交错发送，然后在另一端重新组装是 HTTP2 的一项增强。这个机制会在整个网络技术栈中引发一系列连锁反应，从而带来巨大的性能提升。
  - 并行交错地发送多个请求，请求之间互不影响
  - 并行交错地发送多个响应，响应之间互不干扰
  - 使用一个连接并行发送多个请求和响应
  - 不必再为绕过 HTTP/1.x 限制而做很多工作
  - 消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间

队首堵塞

> 就是需要排队，队首的事情没有处理完的时候，后面的人都要等着

http1.0的队首堵塞
> 对于同一个TCP连接，所有的http1.0请求放入队列中，只有一个请求的响应收到了，才会发送下一个请求，可见http1.0队首阻塞发生在客户端

http1.1的队首堵塞

> 对于同一个tcp连接，http1.1允许一次性发送多个http1.1请求，也就是说不必等前一个响应收到，就可以发送下一个请求，这样就解决了客户端的队首阻塞，但是http1.1规定，服务器端的响应的发送要根据请求被接收的顺序排队，也就是说，先接收到请求，响应也要先发送，如果最先收到的请求处理时间长，响应时间野蛮，就会阻塞已经生成的响应的发送，这也是队首阻塞

http2解决队首阻塞
> http2无论在客户端还是在服务其端都不需要排队，在同一个tcp连接上，有多个stream,由各个stream发送和接收http请求，各个stream相互独立，互不阻塞


### HTTP服务器推送
1. HTTP/2新增的一个非常大的新功能是，服务器可以对一个客户端请求发送多个响应。换句话说，除了对最初请求的响应外，服务器还可以向客户端推送额外资源，而无需客户端明确的请求

2. HTTP/2打破了严格的请求-响应语义，支持一对多和服务器发起的推送工作流

3. 服务器已经知道客户端下一步要请求什么资源，这时候服务器推送即可派上用场

4. 推送资源可以进行一下处理
  - 由客户端缓存
  - 在不同页面之间重用
  - 与其他资源一起复用
  - 由服务器设定优先级
  - 被客户端拒绝

### HTTP伪头字段  
伪头部字段是http2内置的几个特殊的以`:`开始的key,用于代替`HTTP/1.x`中请求行/响应行中的信息
- :method 目标URL模式部分（请求）
- :scheme 目标URL模式部分（请求）
- :authority  目标URL认证部分（请求）
- :path  目标URL的路径和查询部分（绝对路径产生式和一个跟着？字符的查询产生式）（请求）
- :status 响应头中的HTTP状态码部分